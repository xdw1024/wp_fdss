<html>
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <meta name="viewport" content="initial-scale=1.0, user-scalable=no" />
    <style type="text/css">
        body, html{width: 100%;height: 100%;margin:0;font-family:"微软雅黑";}
        #allmap{height:100%;width:100%;}
    </style>
    <script type="text/javascript" src="http://api.map.baidu.com/api?v=2.0&ak=DD279b2a90afdf0ae7a3796787a0742e"></script>
    <title>城市名定位</title>
</head>
<body>
<div id="r-result" style="position:absolute; z-index:2;" >
    <label>区域/城市名: </label><input id="cityName" type="text" style="width:200px; margin-right:10px;" />
    <input type="button" value="查询" onclick="theLocation()" />
</div>
<div id="allmap"></div>
<!--start初始化数据-->
<input type="hidden" id="x_point_new" value="{$x_coord_new}">
<input type="hidden" id="x_point_old" value="{$x_coord_old}">
<input type="hidden" id="y_point_new" value="{$y_coord_new}">
<input type="hidden" id="y_point_old" value="{$y_coord_old}">
{foreach $map_zones as $key=>$value }
<input type="hidden" name="map_zone" data_name="{$key}" data_points="{$value}">
{/foreach}
<!--end 初始化数据-->
</body>
</html>
<script type="text/javascript">
    // 百度地图API功能
    var map = new BMap.Map("allmap");
    //var point = new BMap.Point(108.296402,22.844226);
    var point = new BMap.Point(110.834891,24.837219);
    map.centerAndZoom(point,18);
    map.enableScrollWheelZoom(true);//鼠标滚轮可缩放地图
    var opts = {offset: new BMap.Size(0, 0)} //定义偏移坐标
    map.addControl(new BMap.NavigationControl({offset: new BMap.Size(0, 30)}));//导航坐标
    map.addControl(new BMap.OverviewMapControl(opts));//缩略图
    map.addControl(new BMap.MapTypeControl(opts));//地图类型
    map.addControl(new BMap.ScaleControl({offset: new BMap.Size(0, 50)}));//添加控件（比例尺），并将空件偏移

    //start 如果是修改操作，则初始化地图标注
    var x_point_new = document.getElementById('x_point_new').value;
    var y_point_new = document.getElementById('y_point_new').value;
    if((x_point_new != '') && (y_point_new != '')){
        //alert(x_point_new + ", " + y_point_new);
        //map.clearOverlays();//清除图层
        var point = new BMap.Point(x_point_new, y_point_new);
        map.centerAndZoom(point,18);
        var marker = new BMap.Marker(point);  // 创建标注
        map.addOverlay(marker);               // 将标注添加到地图中
        marker.setAnimation(BMAP_ANIMATION_BOUNCE); //跳动的动画
    }
    //end 如果是修改操作，则初始化地图标注

    // 创建地址解析器实例
    var myGeo = new BMap.Geocoder();
    //start 地点查询
    function theLocation(){
        var city = document.getElementById("cityName").value;
        if(city != ""){
            map.centerAndZoom(city,18);      // 用城市名设置地图中心点

            // 将地址解析结果显示在地图上,并调整地图视野
            myGeo.getPoint(city, function(point){
                if (point) {
                    map.clearOverlays();//清除图层
                    map.centerAndZoom(point, 18);
                    var marker = new BMap.Marker(point);  // 创建标注
                    map.addOverlay(marker);               // 将标注添加到地图中
                    marker.setAnimation(BMAP_ANIMATION_BOUNCE); //跳动的动画
                }else{
                    alert("抱歉，您输入的地址没有查到!");
                }
            }, city);
        }
    }
    //end 地点查询

    //start 鼠标定点标注
    function showInfo(e){
        map.clearOverlays();//清除图层
        //alert(e.point.lng + ", " + e.point.lat);
        var point = new BMap.Point(e.point.lng, e.point.lat);
        var marker = new BMap.Marker(point);  // 创建标注
        map.addOverlay(marker);               // 将标注添加到地图中
        parent.document.getElementById('x_point').value = e.point.lng ;
        parent.document.getElementById('y_point').value = e.point.lat;
        var zone_name = checkBelongZone(point);
//        var select = parent.document.getElementById('zone_id');
//        for(var i=0; i<select.options.length; i++){
//            console.log(select.options[i].innerHTML);
//            if(select.options[i].innerHTML == zone_name){
//                select.options[i].selected = true;
//                break;
//            }
//        }
        var select = parent.document.getElementById('zone_id');
        for(var i=0; i<select.options.length; i++){
            if(select.options[i].innerHTML == zone_name){
                select.options[i].selected = true;
                break;
            }
        }

    }
    map.addEventListener("click", showInfo);
    //end 鼠标定点标注

</script>