<html>
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <meta name="viewport" content="initial-scale=1.0, user-scalable=no" />
    <style type="text/css">
        body, html{width: 100%;height: 100%;margin:0;font-family:"微软雅黑";}
        #allmap{height:100%;width:100%;}
    </style>
    <script type="text/javascript" src="http://api.map.baidu.com/api?v=2.0&ak=DD279b2a90afdf0ae7a3796787a0742e"></script>
    <title>城市名定位</title>
</head>
<body>
<div id="allmap"></div>
<!--start初始化数据-->
<input type="hidden" id="x_point" value="{$x_point}">
<input type="hidden" id="y_point" value="{$y_point}">
<input type="hidden" id="cityName" value="{$cityName}">
<input type="hidden" id="person_points" value="{$person_points}">
<!--end 初始化数据-->
</body>
</html>
<script type="text/javascript">
    // 百度地图API功能
    //var map = new BMap.Map("allmap");
    var map = new BMap.Map("allmap",{enableMapClick: false});//去掉地图原有地点的点击事件
    var point = new BMap.Point(108.296402,22.844226);
    map.centerAndZoom(point,18);
    map.enableScrollWheelZoom(true);//鼠标滚轮可缩放地图

    var opts = {offset: new BMap.Size(0, 0)} //定义偏移坐标
    map.addControl(new BMap.NavigationControl(opts));//导航坐标
    map.addControl(new BMap.OverviewMapControl(opts));//缩略图
    map.addControl(new BMap.MapTypeControl({offset: new BMap.Size(0, 0)}));//地图类型
    map.addControl(new BMap.ScaleControl({offset: new BMap.Size(0, 50)}));//添加控件（比例尺），并将空件偏移

    var current_zone_polygon;//当前查询区域
    //var cityName = '广西壮族自治区';
    var cityName = '恭城瑶族自治县';
    // start 页面初始加载
    setTimeout(function(){ //全局轮廓
        //alert('只加载一次！');
        getBoundary(cityName);
    }, 1);
    setTimeout(function(){ //标注上所有人员位置，必须的等待边界轮廓加载完后再执行
        setAllPersonLocal();
    }, 1000);
    // end 页面初始加载

    //start 初始化 显示所有人员位置
    function setAllPersonLocal() {
        var persons = document.getElementById('person_points').value;
        var personsJsonObj = eval("(" + persons + ")");
        addPersonLocal(personsJsonObj);
    }
    //end 初始化 显示所有人员位置

    //start 刷新人员位置（在../admin/view/mapperson/index.html中调用）
    function myrefresh(personsJsonObj)
    {
        //获取当前地图的级别和中心点
        var zoom = map.getZoom();
        var center = map.getCenter();

        map.clearOverlays();//清除图层
        addPersonLocal(personsJsonObj);//重新添加人员图标

        //重置更新前地图的级别和中心点
        map.setZoom(zoom);
        map.setCenter(center);
    }
    //end 刷新人员位置

    // start 行政区域显示
    function getBoundary(cityName){
        var bdary = new BMap.Boundary();
        bdary.get(cityName, function(rs){       //获取行政区域
            map.clearOverlays();        //清除地图覆盖物
            var count = rs.boundaries.length; //行政区域的点有多少个
            if (count === 0) {
                alert('未能获取当前输入行政区域');
                return ;
            }
            var pointArray = [];
            for (var i = 0; i < count; i++) {
                var ply = new BMap.Polygon(rs.boundaries[i], {strokeWeight: 3, strokeColor: "#ff0000"}); //建立多边形覆盖物
                ply.setFillOpacity(0.1);//设置填充背景透明度
                current_zone_polygon = ply;
                map.addOverlay(ply);  //添加覆盖物
                pointArray = pointArray.concat(ply.getPath());
            }
            map.setViewport(pointArray);    //调整视野
        });
    }
    // end 行政区域显示

    //start 自定义区域显示
    function  getBoundaryMy(zone_points) {
        map.clearOverlays();//清除图层
        var points=eval("("+zone_points+")");
        var polygon = new BMap.Polygon(points, {strokeColor:"#888877", strokeWeight:3, strokeOpacity:1});  //创建多边形
        polygon.setFillOpacity(0.1);//设置填充背景透明度
        polygon.setStrokeStyle('dashed');//设置边线样式(虚线)
        current_zone_polygon = polygon;
        map.addOverlay(polygon);   //增加多边形
        map.setViewport(polygon.getPath());    //调整视野
    }
    //end 自定义区域显示

    //start 多边形区域搜索
    function isPointInPolygon(point, polygon){
        //检查类型
        if(!(point instanceof BMap.Point) ||
                !(polygon instanceof BMap.Polygon)){
            return false;
        }

        //首先判断点是否在多边形的外包矩形内，如果在，则进一步判断，否则返回false
        var polygonBounds = polygon.getBounds();
        if(!isPointInRect(point, polygonBounds)){
            return false;
        }

        var pts = polygon.getPath();//获取多边形点

        //基本思想是利用射线法，计算射线与多边形各边的交点，如果是偶数，则点在多边形外，否则
        //在多边形内。还会考虑一些特殊情况，如点在多边形顶点上，点在多边形边上等特殊情况。
        var N = pts.length;
        var boundOrVertex = true; //如果点位于多边形的顶点或边上，也算做点在多边形内，直接返回true
        var intersectCount = 0;//cross points count of x
        var precision = 2e-10; //浮点类型计算时候与0比较时候的容差
        var p1, p2;//neighbour bound vertices
        var p = point; //测试点

        p1 = pts[0];
        for(var i = 1; i <= N; ++i){
            if(p.equals(p1)){
                return boundOrVertex;
            }

            p2 = pts[i % N];
            if(p.lat < Math.min(p1.lat, p2.lat) || p.lat > Math.max(p1.lat, p2.lat)){
                p1 = p2;
                continue;
            }

            if(p.lat > Math.min(p1.lat, p2.lat) && p.lat < Math.max(p1.lat, p2.lat)){
                if(p.lng <= Math.max(p1.lng, p2.lng)){
                    if(p1.lat == p2.lat && p.lng >= Math.min(p1.lng, p2.lng)){
                        return boundOrVertex;
                    }

                    if(p1.lng == p2.lng){
                        if(p1.lng == p.lng){
                            return boundOrVertex;
                        }else{
                            ++intersectCount;
                        }
                    }else{
                        var xinters = (p.lat - p1.lat) * (p2.lng - p1.lng) / (p2.lat - p1.lat) + p1.lng;
                        if(Math.abs(p.lng - xinters) < precision){
                            return boundOrVertex;
                        }

                        if(p.lng < xinters){
                            ++intersectCount;
                        }
                    }
                }
            }else{
                if(p.lat == p2.lat && p.lng <= p2.lng){
                    var p3 = pts[(i+1) % N];
                    if(p.lat >= Math.min(p1.lat, p3.lat) && p.lat <= Math.max(p1.lat, p3.lat)){
                        ++intersectCount;
                    }else{
                        intersectCount += 2;
                    }
                }
            }
            p1 = p2;
        }

        if(intersectCount % 2 == 0){
            return false;
        } else {
            return true;
        }
    }
    //end 多边形区域搜索

    //start 判断点是否在矩形内
    function isPointInRect(point, bounds){
        //检查类型是否正确
        if (!(point instanceof BMap.Point) ||
                !(bounds instanceof BMap.Bounds)) {
            return false;
        }
        var sw = bounds.getSouthWest(); //西南脚点
        var ne = bounds.getNorthEast(); //东北脚点
        return (point.lng >= sw.lng && point.lng <= ne.lng && point.lat >= sw.lat && point.lat <= ne.lat);
    }
    //end 判断点是否在矩形内

    //start 将人员位置集添加到地图
    function addPersonLocal(persons) {
        map.clearOverlays();//清除图层
        map.addOverlay(current_zone_polygon);   //增加多边形（添加区域轮廓）
        map.setViewport(current_zone_polygon.getPath());    //调整视野
        //console.log(persons);
        var html = '';
        for (var i = 0; i < persons.length; i ++) {
            var point = new BMap.Point(persons[i].x_coord,persons[i].y_coord);//把单位坐标值转为 map 点
            //判断是否在查询区域
            if(isPointInPolygon(point,current_zone_polygon)){
                //设置单位详情信息窗口显示内容
                if(persons[i].crinfo == null){
                    var explain = "";
                }else{
                    var explain = persons[i].crinfo;
                }
                if(persons[i].username == null){
                    var username = "未分配";
                }else{
                    var username = persons[i].username;
                }
                var content = "名称："+persons[i].username
                        +"</br>编号："+persons[i].account;
                var person_marker = addMarkerAutoSize(point,content,'person_icon/p01.png',40);
                var person_name_lable = addLable(persons[i].username);
                person_marker.setLabel(person_name_lable);
                //start 累加查询结果，用于更新列表板块信息
                var person_json = JSON.stringify(persons[i]).replace(/\"/g,"'");//js 对象转为json ,并将其中的双引号改为单引号
                html += '<div class="map_search_result" >' +
                        '<p><a href="#" onclick="person_detail_show('+ person_json +')" style="text-decoration:underline;color:#3c8dbc;" >'+persons[i].username+'</a></p>' +
//                        '<p>'+persons[i].account+'</p>' +
                        '</div>';
                //end 累加查询结果，用于更新列表板块信息
            }
        }
        //return html;
        window.parent.addPersonInfoList(html);
    }
    //end 将人员位置集添加到地图

    //start 创建覆盖物的文字标签
    function addLable(content) {
        var label = new BMap.Label(content,{offset:new BMap.Size(20,-10)});
        return label;
    }
    //end 创建覆盖物的文字标签

    //start 创建地图标注
    function addMarkerAutoSize(point,content,icon,size){
        var myIcon = new BMap.Icon("__UPLOAD_IMGE__/"+icon+"", new BMap.Size(size,size));
        var marker = new BMap.Marker(point,{icon:myIcon});
        map.addOverlay(marker);
        //var content="sss";
        addClickHandler(content,marker);
        return marker;
    }
    //end 创建地图标注

    //start 创建地图标注
    function addMarker(point,content,icon){
        var iconSize = new BMap.Size(20,20);
        var iconOption = {
            imageSize:iconSize
        };
        var myIcon = new BMap.Icon("__UPLOAD_IMGE__/"+icon+"", iconSize,iconOption);
        //myIcon.setImageSize(iconSize);
        var marker = new BMap.Marker(point,{icon:myIcon});
        map.addOverlay(marker);
        //var content="sss";
        addClickHandler(content,marker);
    }
    //end 创建地图标注

    /**
     * 地图上显示单位详情
     * @author yxf
     */
    //start 创建单位详情点击事件
    function addClickHandler(content,marker){
        marker.addEventListener("click",function(e){
            openInfo(content,e)}
        );
    }
    //end 创建单位详情点击事件

    //信息窗口显示单位详情
    function openInfo(content,e){
        var p = e.target;
        var point = new BMap.Point(p.getPosition().lng, p.getPosition().lat);
        var infoWindow = new BMap.InfoWindow(content,opts);  // 创建信息窗口对象
        map.openInfoWindow(infoWindow,point); //开启信息窗口
    }
    //信息窗口显示单位详情

    /**
     * start 查询列表点击单位，在地图上定位并显示
     * @author xdw
     * @param data
     */
    function person_location_and_show(person){
        if(person.username == null){
            var username = "未分配";
        }else{
            var username = person.username;
        }
        var content = "名称："+person.username+"</br>编号："+person.account;
        var point = new BMap.Point(person.x_coord, person.y_coord);
        map.centerAndZoom(point,18);
        var infoWindow = new BMap.InfoWindow(content,opts);  // 创建信息窗口对象
        map.openInfoWindow(infoWindow,point); //开启信息窗口
    }
    /** end 查询列表点击单位，在地图上定位并显示*/

</script>