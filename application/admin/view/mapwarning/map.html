<html>
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <meta name="viewport" content="initial-scale=1.0, user-scalable=no" />
    <style type="text/css">
        body, html{width: 100%;height: 100%;margin:0;font-family:"微软雅黑";}
        #allmap{height:100%;width:100%;}
    </style>
    <script type="text/javascript" src="http://api.map.baidu.com/api?v=2.0&ak=DD279b2a90afdf0ae7a3796787a0742e"></script>
    <title>城市名定位</title>
</head>
<body>
<div id="allmap"></div>
<!--start初始化数据-->
<input type="hidden" id="x_point" value="{$x_point}">
<input type="hidden" id="y_point" value="{$y_point}">
<input type="hidden" id="cityName" value="{$cityName}">
<input type="hidden" id="points" value="{$points}">
<!--end 初始化数据-->
</body>
</html>
<script type="text/javascript">
    // 百度地图API功能
    //var map = new BMap.Map("allmap");
    var map = new BMap.Map("allmap",{enableMapClick: false});//去掉地图原有地点的点击事件
    var point = new BMap.Point(108.296402,22.844226);
    map.centerAndZoom(point,18);
    map.enableScrollWheelZoom(true);//鼠标滚轮可缩放地图

    var opts = {offset: new BMap.Size(0, 0)} //定义偏移坐标
    map.addControl(new BMap.NavigationControl(opts));//导航坐标
    map.addControl(new BMap.OverviewMapControl(opts));//缩略图
    map.addControl(new BMap.MapTypeControl({offset: new BMap.Size(0, 0)}));//地图类型
    map.addControl(new BMap.ScaleControl({offset: new BMap.Size(0, 50)}));//添加控件（比例尺），并将空件偏移

    var current_zone_polygon;//当前查询区域
    //var cityName = '广西壮族自治区';
    var cityName = '恭城瑶族自治县';
    // start 页面初始加载
    setTimeout(function(){ //全局轮廓
        //alert('只加载一次！');
        getBoundary(cityName);
    }, 1);
    setTimeout(function(){ //标注上所有单位，必须的等待边界轮廓加载完后再执行
        setAllUnit();
    }, 1000);
    // end 页面初始加载

    //start 初始化 显示所有单位
    function setAllUnit() {
        var units = document.getElementById('points').value;
        var unitsJsonObj = eval("(" + units + ")");
        addUnit(unitsJsonObj);
    }
    //end 初始化 显示所有单位

    // start 行政区域显示
    function getBoundary(cityName){
        var bdary = new BMap.Boundary();
        bdary.get(cityName, function(rs){       //获取行政区域
            map.clearOverlays();        //清除地图覆盖物
            var count = rs.boundaries.length; //行政区域的点有多少个
            if (count === 0) {
                alert('未能获取当前输入行政区域');
                return ;
            }
            var pointArray = [];
            for (var i = 0; i < count; i++) {
                var ply = new BMap.Polygon(rs.boundaries[i], {strokeWeight: 3, strokeColor: "#ff0000"}); //建立多边形覆盖物
                ply.setFillOpacity(0.1);//设置填充背景透明度
                current_zone_polygon = ply;
                map.addOverlay(ply);  //添加覆盖物
                pointArray = pointArray.concat(ply.getPath());
            }
            map.setViewport(pointArray);    //调整视野
        });
    }
    // end 行政区域显示

    //start 自定义区域显示
    function  getBoundaryMy(zone_points) {
        map.clearOverlays();//清除图层
        var points=eval("("+zone_points+")");
        var polygon = new BMap.Polygon(points, {strokeColor:"#888877", strokeWeight:3, strokeOpacity:1});  //创建多边形
        polygon.setFillOpacity(0.1);//设置填充背景透明度
        polygon.setStrokeStyle('dashed');//设置边线样式(虚线)
        current_zone_polygon = polygon;
        map.addOverlay(polygon);   //增加多边形
        map.setViewport(polygon.getPath());    //调整视野
    }
    //end 自定义区域显示

    //start 显示自定义区域2
    function  getBoundaryMy2() {

        var polygon = new BMap.Polygon([
            new BMap.Point(108.289494,22.860636),
            new BMap.Point(108.289854,22.839988),
            new BMap.Point(108.299052,22.836724),
            new BMap.Point(108.318743,22.84565),
            new BMap.Point(108.310335,22.858971),
            new BMap.Point(108.289351,22.860636),
            new BMap.Point(108.289351,22.860636),
            new BMap.Point(108.289351,22.860636),
            new BMap.Point(108.289351,22.860636)
        ], {strokeColor:"red", strokeWeight:3, strokeOpacity:1});  //创建多边形
        polygon.setFillOpacity(0.1);//设置填充背景透明度
        map.addOverlay(polygon);   //增加多边形
        map.setViewport(polygon.getPath());    //调整视野

        var point = new BMap.Point(108.2966,22.844243);
        var point2 = new BMap.Point(108.326882,22.840583);
        if(isPointInPolygon(point2,polygon)){
            alert("该point在circle内");
        }
        else{
            alert("不在");
        }
    }
    //end 显示自定义区域2

    //start 多边形区域搜索
    function isPointInPolygon(point, polygon){
        //检查类型
        if(!(point instanceof BMap.Point) ||
                !(polygon instanceof BMap.Polygon)){
            return false;
        }

        //首先判断点是否在多边形的外包矩形内，如果在，则进一步判断，否则返回false
        var polygonBounds = polygon.getBounds();
        if(!isPointInRect(point, polygonBounds)){
            return false;
        }

        var pts = polygon.getPath();//获取多边形点

        //基本思想是利用射线法，计算射线与多边形各边的交点，如果是偶数，则点在多边形外，否则
        //在多边形内。还会考虑一些特殊情况，如点在多边形顶点上，点在多边形边上等特殊情况。
        var N = pts.length;
        var boundOrVertex = true; //如果点位于多边形的顶点或边上，也算做点在多边形内，直接返回true
        var intersectCount = 0;//cross points count of x
        var precision = 2e-10; //浮点类型计算时候与0比较时候的容差
        var p1, p2;//neighbour bound vertices
        var p = point; //测试点

        p1 = pts[0];
        for(var i = 1; i <= N; ++i){
            if(p.equals(p1)){
                return boundOrVertex;
            }

            p2 = pts[i % N];
            if(p.lat < Math.min(p1.lat, p2.lat) || p.lat > Math.max(p1.lat, p2.lat)){
                p1 = p2;
                continue;
            }

            if(p.lat > Math.min(p1.lat, p2.lat) && p.lat < Math.max(p1.lat, p2.lat)){
                if(p.lng <= Math.max(p1.lng, p2.lng)){
                    if(p1.lat == p2.lat && p.lng >= Math.min(p1.lng, p2.lng)){
                        return boundOrVertex;
                    }

                    if(p1.lng == p2.lng){
                        if(p1.lng == p.lng){
                            return boundOrVertex;
                        }else{
                            ++intersectCount;
                        }
                    }else{
                        var xinters = (p.lat - p1.lat) * (p2.lng - p1.lng) / (p2.lat - p1.lat) + p1.lng;
                        if(Math.abs(p.lng - xinters) < precision){
                            return boundOrVertex;
                        }

                        if(p.lng < xinters){
                            ++intersectCount;
                        }
                    }
                }
            }else{
                if(p.lat == p2.lat && p.lng <= p2.lng){
                    var p3 = pts[(i+1) % N];
                    if(p.lat >= Math.min(p1.lat, p3.lat) && p.lat <= Math.max(p1.lat, p3.lat)){
                        ++intersectCount;
                    }else{
                        intersectCount += 2;
                    }
                }
            }
            p1 = p2;
        }

        if(intersectCount % 2 == 0){
            return false;
        } else {
            return true;
        }
    }
    //end 多边形区域搜索

    //start 判断点是否在矩形内
    function isPointInRect(point, bounds){
        //检查类型是否正确
        if (!(point instanceof BMap.Point) ||
                !(bounds instanceof BMap.Bounds)) {
            return false;
        }
        var sw = bounds.getSouthWest(); //西南脚点
        var ne = bounds.getNorthEast(); //东北脚点
        return (point.lng >= sw.lng && point.lng <= ne.lng && point.lat >= sw.lat && point.lat <= ne.lat);
    }
    //end 判断点是否在矩形内


    //start 将单位集添加到地图
    function addUnit(units) {
        map.clearOverlays();//清除图层
        map.addOverlay(current_zone_polygon);   //增加多边形（添加区域轮廓）
        map.setViewport(current_zone_polygon.getPath());    //调整视野
        //console.log(units);
        var html = '';
        for (var i = 0; i < units.length; i ++) {
            var point = new BMap.Point(units[i].x_coord,units[i].y_coord);//把单位坐标值转为 map 点
            //判断是否在查询区域
            if(isPointInPolygon(point,current_zone_polygon)){
                //设置单位详情信息窗口显示内容
                if(units[i].crinfo == null){
                    var explain = "";
                }else{
                    var explain = units[i].crinfo;
                }
                if(units[i].username == null){
                    var username = "未分配";
                }else{
                    var username = units[i].username;
                }
                var content = "名称："+units[i].name
                        +"</br>地址："+units[i].addr
                        +"</br>类型："+units[i].unittype
                        +"</br>检查人："+username;
                addWarningMarker(point);
                addMarker(point,content,units[i].icon);
                //start 累加查询结果，用于更新列表板块信息
                var unit_json = JSON.stringify(units[i]).replace(/\"/g,"'");//js 对象转为json ,并将其中的双引号改为单引号
                html += '<div class="map_search_result">' +
                        '<p><a href="#" onclick="warning_detail_show('+ unit_json +')">'+units[i].name+'</a></p>' +
                        '<p>地址：'+units[i].addr+'</p>' +
                        '</div>';
                //end 累加查询结果，用于更新列表板块信息
            }
        }
        //return html;
        window.parent.addWarningUnitInfoList(html);
    }
    //end 将单位集添加到地图

    //start 添加预警图标
    function addWarningMarker(point,content,icon){
        var iconSize = new BMap.Size(50,50);
        var imageOffset = new BMap.Size(-2,-2);
        var iconOption = {
            imageOffset:imageOffset,
            imageSize:iconSize
        };
        var myIcon = new BMap.Icon("__UPLOAD_IMGE__tool_icon/yj_01.gif",iconSize,iconOption);
        var marker = new BMap.Marker(point,{icon:myIcon});
        map.addOverlay(marker);
    }
    //end 添加预警图标

    //start 创建地图标注
    function addMarker(point,content,icon){
        var iconSize = new BMap.Size(18,18);
        var iconOption = {
            imageSize:iconSize
        };
        var myIcon = new BMap.Icon("__UPLOAD_IMGE__/"+icon+"", iconSize,iconOption);
        //myIcon.setImageSize(iconSize);
        var marker = new BMap.Marker(point,{icon:myIcon});
        map.addOverlay(marker);
        //var content="sss";
        addClickHandler(content,marker);
    }
    //end 创建地图标注

    /**
     * 地图上显示单位详情
     * @author yxf
     */
    //start 创建单位详情点击事件
    function addClickHandler(content,marker){
        marker.addEventListener("click",function(e){
            openInfo(content,e)}
        );
    }
    //end 创建单位详情点击事件

    //信息窗口显示单位详情
    function openInfo(content,e){
        var p = e.target;
        var point = new BMap.Point(p.getPosition().lng, p.getPosition().lat);
        var infoWindow = new BMap.InfoWindow(content,opts);  // 创建信息窗口对象
        map.openInfoWindow(infoWindow,point); //开启信息窗口
    }
    //信息窗口显示单位详情

    /**
     * start 查询列表点击单位，在地图上定位并显示
     * @author xdw
     * @param data
     */
    function unit_location_and_show(unit){
        if(unit.username == null){
            var username = "未分配";
        }else{
            var username = unit.username;
        }
        var content = "名称："+unit.name+"</br>地址："+unit.addr+"</br>类型："+unit.unittype+"</br>检查人："+username;//设置单位详情信息窗口显示内容
        var point = new BMap.Point(unit.x_coord, unit.y_coord);
        map.centerAndZoom(point,18);
        var infoWindow = new BMap.InfoWindow(content,opts);  // 创建信息窗口对象
        map.openInfoWindow(infoWindow,point); //开启信息窗口
    }
    /** end 查询列表点击单位，在地图上定位并显示*/

</script>