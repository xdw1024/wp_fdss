<html>
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <meta name="viewport" content="initial-scale=1.0, user-scalable=no" />
    <style type="text/css">
        body, html{width: 100%;height: 100%;margin:0;font-family:"微软雅黑";}
        #allmap{height:100%;width:100%;}
    </style>
    <script type="text/javascript" src="http://api.map.baidu.com/api?v=2.0&ak=DD279b2a90afdf0ae7a3796787a0742e"></script>
    <title>城市名定位</title>
</head>
<body>
<div id="allmap"></div>
<!--start初始化数据-->
<input type="hidden" id="x_point" value="{$x_point}">
<input type="hidden" id="y_point" value="{$y_point}">
<input type="hidden" id="cityName" value="{$cityName}">
<input type="hidden" id="points" value="{$points}">
<!--end 初始化数据-->
</body>
</html>
<script type="text/javascript">
    // 百度地图API功能
    //var map = new BMap.Map("allmap");
    var map = new BMap.Map("allmap",{enableMapClick: false});//去掉地图原有地点的点击事件
    var point = new BMap.Point(108.296402,22.844226);
    map.centerAndZoom(point,18);
    map.enableScrollWheelZoom(true);//鼠标滚轮可缩放地图

    var opts = {offset: new BMap.Size(0, 0)};//定义偏移坐标
    map.addControl(new BMap.NavigationControl(opts));//导航坐标
    map.addControl(new BMap.OverviewMapControl(opts));//缩略图
    map.addControl(new BMap.MapTypeControl({offset: new BMap.Size(0, 0)}));//地图类型
    map.addControl(new BMap.ScaleControl({offset: new BMap.Size(0, 50)}));//添加控件（比例尺），并将空件偏移

    var current_zone_polygon;//当前查询区域
    //var cityName = '广西壮族自治区';
    var cityName = '恭城瑶族自治县';
    // start 页面初始加载
    setTimeout(function(){ //全局轮廓
        //alert('只加载一次！');
        getBoundary(cityName);
    }, 1);
    setTimeout(function(){ //标注上所有单位，必须等待边界轮廓加载完后再执行
        setAllUnit();
    }, 1000);
    // end 页面初始加载

    var map_level;//地图等级
    var unit_container;//单位容器
    //start 监听当前地图缩放后的级别，并调整单位密度
    map.addEventListener("zoomend", addUnitHandle);
    function addUnitHandle() {
        map_level = map.getZoom();
        if(typeof (unit_container) == 'undefined'){
            return;
        }
        var new_unit = unitDensityHandle_2(unit_container,map_level);
        addUnit(new_unit);
    }
    //end 监听当前地图缩放后的级别，并调整单位密度

    //start 初始化 显示所有单位
    function setAllUnit() {
        var units = document.getElementById('points').value;
        var unitsJsonObj = eval("(" + units + ")");
        unit_container = unitsJsonObj;
        addUnitHandle();
    }
    //end 初始化 显示所有单位

    // start 行政区域显示
    function getBoundary(cityName){
        var bdary = new BMap.Boundary();
        bdary.get(cityName, function(rs){       //获取行政区域
            map.clearOverlays();        //清除地图覆盖物
            var count = rs.boundaries.length; //行政区域的点有多少个
            if (count === 0) {
                alert('未能获取当前输入行政区域');
                return ;
            }
            var pointArray = [];
            for (var i = 0; i < count; i++) {
                var ply = new BMap.Polygon(rs.boundaries[i], {strokeWeight: 3, strokeColor: "#ff0000"}); //建立多边形覆盖物
                ply.setFillOpacity(0.1);//设置填充背景透明度
                current_zone_polygon = ply;
                map.addOverlay(ply);  //添加覆盖物
                pointArray = pointArray.concat(ply.getPath());
            }
            map.setViewport(pointArray);    //调整视野
        });
    }
    // end 行政区域显示

    //start 自定义区域显示
    function  getBoundaryMy(zone_points) {
        map.clearOverlays();//清除图层
        var points=eval("("+zone_points+")");
        var polygon = new BMap.Polygon(points, {strokeColor:"#888877", strokeWeight:3, strokeOpacity:1});  //创建多边形
        polygon.setFillOpacity(0.1);//设置填充背景透明度
        polygon.setStrokeStyle('dashed');//设置边线样式(虚线)
        //current_zone_polygon = polygon;
        //map.addOverlay(polygon);   //增加多边形
        map.setViewport(polygon.getPath());    //调整视野
    }
    //end 自定义区域显示

    //start 多边形区域搜索 (废弃)
    function isPointInPolygon(point, polygon){
        //检查类型
        if(!(point instanceof BMap.Point) ||
                !(polygon instanceof BMap.Polygon)){
            return false;
        }

        //首先判断点是否在多边形的外包矩形内，如果在，则进一步判断，否则返回false
        var polygonBounds = polygon.getBounds();
        if(!isPointInRect(point, polygonBounds)){
            return false;
        }

        var pts = polygon.getPath();//获取多边形点

        //基本思想是利用射线法，计算射线与多边形各边的交点，如果是偶数，则点在多边形外，否则
        //在多边形内。还会考虑一些特殊情况，如点在多边形顶点上，点在多边形边上等特殊情况。
        var N = pts.length;
        var boundOrVertex = true; //如果点位于多边形的顶点或边上，也算做点在多边形内，直接返回true
        var intersectCount = 0;//cross points count of x
        var precision = 2e-10; //浮点类型计算时候与0比较时候的容差
        var p1, p2;//neighbour bound vertices
        var p = point; //测试点

        p1 = pts[0];
        for(var i = 1; i <= N; ++i){
            if(p.equals(p1)){
                return boundOrVertex;
            }

            p2 = pts[i % N];
            if(p.lat < Math.min(p1.lat, p2.lat) || p.lat > Math.max(p1.lat, p2.lat)){
                p1 = p2;
                continue;
            }

            if(p.lat > Math.min(p1.lat, p2.lat) && p.lat < Math.max(p1.lat, p2.lat)){
                if(p.lng <= Math.max(p1.lng, p2.lng)){
                    if(p1.lat == p2.lat && p.lng >= Math.min(p1.lng, p2.lng)){
                        return boundOrVertex;
                    }

                    if(p1.lng == p2.lng){
                        if(p1.lng == p.lng){
                            return boundOrVertex;
                        }else{
                            ++intersectCount;
                        }
                    }else{
                        var xinters = (p.lat - p1.lat) * (p2.lng - p1.lng) / (p2.lat - p1.lat) + p1.lng;
                        if(Math.abs(p.lng - xinters) < precision){
                            return boundOrVertex;
                        }

                        if(p.lng < xinters){
                            ++intersectCount;
                        }
                    }
                }
            }else{
                if(p.lat == p2.lat && p.lng <= p2.lng){
                    var p3 = pts[(i+1) % N];
                    if(p.lat >= Math.min(p1.lat, p3.lat) && p.lat <= Math.max(p1.lat, p3.lat)){
                        ++intersectCount;
                    }else{
                        intersectCount += 2;
                    }
                }
            }
            p1 = p2;
        }

        if(intersectCount % 2 == 0){
            return false;
        } else {
            return true;
        }
    }
    //end 多边形区域搜索

    //start 判断点是否在矩形内 （废弃）
    function isPointInRect(point, bounds){
        //检查类型是否正确
        if (!(point instanceof BMap.Point) ||
                !(bounds instanceof BMap.Bounds)) {
            return false;
        }
        var sw = bounds.getSouthWest(); //西南脚点
        var ne = bounds.getNorthEast(); //东北脚点
        return (point.lng >= sw.lng && point.lng <= ne.lng && point.lat >= sw.lat && point.lat <= ne.lat);
    }
    //end 判断点是否在矩形内

    /**
     * 单位密度抽稀
     * @param $units 单位集
     * @param int $level 地图级别
     * @return array
     */
    function unitDensityHandle_1(units,level){

        var min = 0.0001;//密度控制
        switch(level){
            case 19:
            case 18:
                min = 1;break;
            case 17:
                min = 0.5;break;
            case 16:
                min = 0.1;break;
            case 15:
                min = 0.05;break;
            case 14:
                min = 0.01;break;
            case 13:
                min = 0.005;break;
            case 12:
                min = 0.001;break;
            default:
                min = 0.0005;
        }
        if(min==1) {
            return units;
        }
        var new_unit = new Array();
        var i = 0;
        for (var j=0; j < units.length-1; j=j+3) {
            var xy1 = units[j];
            var x1 = xy1.x_coord;
            var y1 = xy1.y_coord;
            var xy2 = units[j+2];
            var x2 = xy2.x_coord;
            var y2 = xy2.y_coord;
            var b = x1 - x2;
            var a = y2 - y1;
            var c = (y1 - y2)*x1 - y1*(x1 -x2);
            var xys = units[j+1];
            var d = (Math.abs(a * xys.x_coord + b * xys.y_coord + c)) / (Math.sqrt(a * a + b * b));
            if(d < min) {
                new_unit[i] = units[j+1];
                i++;
            }
        }
        alert(level+'---'+ min +'---'+ units.length +'---'+new_unit.length);
        return new_unit;
    }
    // end 单位密度抽稀

    /**
     * 单位密度抽稀
     * 思路：为每个层级设定最大显示数，而不是根据层级来设定单位显示数量的比例
     * @param $units 单位集
     * @param int $level 地图级别
     * @return array
     */
    function unitDensityHandle_2(units,level){
        
        var units_count = units.length;
        var level_max_show = units_count;//该层级中最大的单位显示数量
        //设定每一层级的显示数量
        switch(level){
            case 19:
            case 18:
                level_max_show =  units_count ;
                break;
            case 17:
                level_max_show = (1000 < units_count)? 1000 : units_count ;
                break;
            case 16:
                level_max_show = (500 < units_count)? 500 : units_count ;
                break;
            case 15:
                level_max_show = (300 < units_count)? 300 : units_count ;
                break;
            case 14:
                level_max_show = (100 < units_count)? 100 : units_count ;
                break;
            case 13:
                level_max_show = (50 < units_count)? 50 : units_count ;
                break;
            case 12:
                level_max_show = (20 < units_count)? 20 : units_count ;
                break;
            default:
                level_max_show = (5 < units_count)? 5 : units_count ;
        }

        var new_unit = new Array();//抽稀后的数组
        if(level_max_show == units_count) {
            new_unit = units;
        }
        else {
            var i = 0;
            for (var j=0; j < level_max_show-1; j++) {
                var rand_index = RandomNumBoth(0,units_count-1);//从所有单位中任选其一
                new_unit[i] = units[rand_index];
                i++;
            }
        }
        //alert(level+'---'+ level_max_show +'---'+ units.length +'---'+new_unit.length);
        return new_unit;
    }
    // end 单位密度抽稀

    //start Min,Max间的随机数
    function RandomNumBoth(Min,Max){
        var Range = Max - Min;
        var Rand = Math.random();
        var num = Min + Math.round(Rand * Range); //四舍五入
        return num;
    }
    //end Min,Max间的随机数

    //start 单位搜索结果处理
    function  addUnitBrige(units){
        unit_container = units;
        //addUnit(units);
        addUnitHandle();
    }
    //end 单位搜索结果处理

    //start 将单位集添加到地图
    function addUnit(units) {
        map.clearOverlays();//清除图层
        map.addOverlay(current_zone_polygon);   //增加多边形（添加区域轮廓）
        //map.setViewport(current_zone_polygon.getPath());    //调整视野
        //console.log(units);
        var html = '';
        for (var i = 0; i < units.length; i ++) {
            var point = new BMap.Point(units[i].x_coord,units[i].y_coord);//把单位坐标值转为 map 点
            //判断是否在查询区域
            //if(isPointInPolygon(point,current_zone_polygon)){
                //设置单位详情信息窗口显示内容
                if(units[i].standard_level == "0"){
                    var check = "合格";
                }else if(units[i].standard_level == "1"){
                    var check = "优秀";
                }else if(units[i].standard_level == "2"){
                    var check = "良好";
                }else if(units[i].standard_level == "3"){
                    var check = "不合格";
                }else{
                    var check = "未检查";
                }
                if(units[i].username == null){
                    var usnickname = "未分配";
                }else{
                    var usnickname = units[i].username;
                }
                if(check == '未检查'){
                    var waring_pic = 'x.png';
                }else{
                    var waring_pic = 'd.png';
                }
                var content = new Array();
            content[0] = "名称："+units[i].name
                        +"</br>地址："+units[i].addr
                        +"</br>类型："+units[i].unittype
                        +"</br>检查人："+usnickname
                        +"</br>状态："+check;
            addMarker(point,content,units[i].icon);
            addWaringMarker(point,waring_pic);//添加警告图标
            content[1] = units[i].id;
                //start 累加查询结果，用于更新列表板块信息
                var unit_json = JSON.stringify(units[i]).replace(/\"/g,"'");//js 对象转为json ,并将其中的双引号改为单引号
                html += '<div class="map_search_result">' +
                        '<p><a href="#" onclick="detail_show('+ unit_json +')">'+units[i].name+'</a></p>' +
                        '<p>地址：'+units[i].addr+'</p>' +
                        '</div>';
                //end 累加查询结果，用于更新列表板块信息
            //}
        }
        //return html;
        window.parent.addUnitInfoList(html);//调用..\view\map\index.html 中的addUnitInfoList（）
    }
    //end 将单位集添加到地图

    //start 创建地图标注
    function addMarker(point,content,icon){
        var iconSize = new BMap.Size(20,20);
        var iconOption = {
            imageSize:iconSize
        };
        var myIcon = new BMap.Icon("__UPLOAD_IMGE__/"+icon+"", iconSize,iconOption);
        //myIcon.setImageSize(iconSize);
        var marker = new BMap.Marker(point,{icon:myIcon});
        map.addOverlay(marker);
        //var content="sss";
        addClickHandler(content,marker);
    }
    //end 创建地图标注

    //start 添加警告标志
    function addWaringMarker(point,waring_pic){
        var iconSize = new BMap.Size(15,15);
        var waringOption = {
            anchor:new BMap.Size(-1,0),
            imageSize:iconSize
        };
        var waringIcon = new BMap.Icon("__UPLOAD_IMGE__tool_icon/"+waring_pic, iconSize,waringOption);
        var markerWaring = new BMap.Marker(point,{icon:waringIcon});
        map.addOverlay(markerWaring);
    }
    //end 添加警告标志

    /**
     * 地图上显示单位详情
     * @author yxf
     */
    //start 创建单位详情点击事件
    function addClickHandler(content,marker){
        marker.addEventListener("click",function(e){
            openInfo(content[0],e);
            //切换单位信息列表
            window.parent.changeTodetail();
            window.parent.get_unit_detail_info(content[1]);
            window.parent.get_unit_check_record_info(content[1]);
        });
    }
    //end 创建单位详情点击事件

    //信息窗口显示单位详情
    function openInfo(content,e){
        var p = e.target;
        var point = new BMap.Point(p.getPosition().lng, p.getPosition().lat);
        var infoWindow = new BMap.InfoWindow(content,opts);  // 创建信息窗口对象
        map.openInfoWindow(infoWindow,point); //开启信息窗口
    }
    //信息窗口显示单位详情

    /**
     * start 查询列表点击单位，在地图上定位并显示
     * @author xdw
     * @param data
     */
    function unit_location_and_show(unit){
        if(unit.standard_level == "0"){
            var check = "合格";
        }else if(unit.standard_level == "1"){
            var check = "优秀";
        }else if(unit.standard_level == "2"){
            var check = "良好";
        }else if(unit.standard_level == "3"){
            var check = "不合格";
        }else{
            var check = "未检查";
        }
        if(unit.username == null){
            var usnickname = "未分配";
        }else{
            var usnickname = unit.username;
        }
        var content = "名称："+unit.name+"</br>地址："+unit.addr+"</br>类型："+unit.unittype+"</br>检查人："+usnickname+"</br>状态："+check;//设置单位详情信息窗口显示内容
        var point = new BMap.Point(unit.x_coord, unit.y_coord);
        map.centerAndZoom(point,18);
        var infoWindow = new BMap.InfoWindow(content,opts);  // 创建信息窗口对象
        map.openInfoWindow(infoWindow,point); //开启信息窗口
    }
    /** end 查询列表点击单位，在地图上定位并显示*/

</script>